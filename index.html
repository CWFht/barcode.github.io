<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>모바일 바코드 스캐너 & 제네레이터</title>
<meta name="theme-color" content="#0f1115" />
<style>
  :root{
    --bg:#0f1115; --card:#171a21; --muted:#1e2433; --ink:#f2f4f8; --sub:#a9b1c3;
    --line:#2a3040; --pri:#0e7afe; --pri-ink:#fff; --radius:14px; --shadow:0 6px 18px rgba(0,0,0,.18);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink);overflow:hidden}

  /* 상단 툴바 */
  .appbar{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#0f1115 0%, #121621 100%);
    border-bottom:1px solid var(--line);padding:10px env(safe-area-inset-right) 10px env(safe-area-inset-left)}
  .toolbar{display:grid;grid-template-columns:1fr auto auto auto;gap:8px}
  .field{display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--line);
    border-radius:var(--radius);padding:0 12px;height:40px}
  .field input{flex:1;background:transparent;border:none;outline:none;color:var(--ink);min-width:0}
  .btn{height:40px;padding:0 12px;border-radius:12px;border:1px solid transparent;background:var(--pri);
    color:var(--pri-ink);font-weight:700;display:inline-flex;align-items:center;gap:8px;box-shadow:var(--shadow)}
  .btn.ghost{background:var(--card);color:var(--ink);border:1px solid var(--line);box-shadow:none}
  .btn.icon{padding:0 10px}
  .icon{width:18px;height:18px;display:inline-block}
  .badge{font-size:12px;background:var(--muted);color:var(--ink);padding:4px 8px;border-radius:999px;border:1px solid var(--line)}

  /* 본문 */
  .section{padding:12px env(safe-area-inset-right) 12px env(safe-area-inset-left);display:flex;flex-direction:column;gap:12px;height:calc(100vh - 62px)}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:10px}
  .scan-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .scanBox{position:relative;border-radius:12px;overflow:hidden;background:#000;border:1px solid var(--line)}
  video{width:100%;display:block;background:#000}

  /* 가이드 박스: 고정 가로비(AR) + CSS 변수 */
  .guide{position:absolute;inset:0;pointer-events:none}
  .guide:after{
    --w:80%; --h:22%; --x:50%; --y:50%;
    content:"";position:absolute;left:var(--x);top:var(--y);
    width:var(--w);height:var(--h);transform:translate(-50%,-50%);
    border:2px solid rgba(255,255,255,.95);border-radius:12px;box-shadow:0 0 0 9999px rgba(0,0,0,.35);
    transition:left .12s ease, top .12s ease;
  }

  /* 목록 10개까지 스크롤 */
  .list{display:flex;flex-direction:column;gap:10px;max-height:40vh;overflow:auto;padding-right:2px}
  .slot{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;background:var(--card);
    border:1px solid var(--line);border-radius:16px;padding:10px 12px;box-shadow:var(--shadow)}
  .slot svg{width:150px;height:64px}
  .code{font-size:14px;letter-spacing:.2px}
  .meta{font-size:11px;color:var(--sub);margin-top:2px}
  .x{width:32px;height:32px;border:none;border-radius:50%;background:var(--muted);color:var(--ink)}

  .hint{color:var(--sub);font-size:12px;margin-top:8px}
</style>
</head>
<body>
  <header class="appbar">
    <div class="toolbar">
      <div class="field"><input id="textInput" placeholder="문자/숫자 입력 (자동 대문자, 수동은 CODE128)" inputmode="latin" autocomplete="off" /></div>
      <button id="genBtn" class="btn"><span class="icon">➕</span>생성</button>
      <button id="scanBtn" class="btn"><span class="icon">📷</span>스캔</button>
      <button id="clearBtn" class="btn ghost icon" title="전체 지움">🗑️</button>
    </div>
  </header>

  <main class="section">
    <div class="panel">
      <div class="scan-head">
        <div style="display:flex;gap:10px;align-items:center">
          <strong>카메라 스캔</strong>
          <span class="badge" id="camStatus">대기</span>
        </div>
        <div style="display:flex;gap:8px">
          <button id="stopBtn" class="btn ghost icon" title="스캔 정지">⏹️</button>
          <button id="torchBtn" class="btn ghost icon" title="토치">🔦</button>
        </div>
      </div>

      <div class="scanBox" id="scanBox" title="바코드 위치를 탭하면 해당 영역만 인식합니다.">
        <video id="preview" playsinline muted></video>
        <div class="guide" id="guide"></div>
      </div>
      <div class="hint" id="lastMsg">가이드 박스를 탭해서 바코드 주변을 지정할 수 있어요.</div>
    </div>

    <div class="list" id="slotCol" aria-label="스캔/생성된 바코드 목록 (최대 10개)"></div>
  </main>

<!-- 생성용 -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<!-- 스캔용 -->
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
<script>
(() => {
  // 세로 고정 (지원 브라우저에서만)
  if (screen.orientation?.lock) { try { screen.orientation.lock('portrait'); } catch(_){} }

  if (!window.ZXing) { alert('ZXing 로드 실패'); return; }

  const MAX = 10;              // 목록 최대
  const COOLDOWN_MS = 1000;    // 인식 후 1초 대기
  let cooldownUntil = 0;

  const state = {
    items: [],               // {id,text,srcFmt,renderFmt}
    lastDetected:"", lastDetectAt:0,
    running:false,
    track:null, torchOn:false,
  };

  // DOM
  const $col = document.getElementById('slotCol');
  const $input = document.getElementById('textInput');
  const $gen = document.getElementById('genBtn');
  const $clear = document.getElementById('clearBtn');
  const $scan = document.getElementById('scanBtn');
  const $stop = document.getElementById('stopBtn');
  const $video = document.getElementById('preview');
  const $camStatus = document.getElementById('camStatus');
  const $torch = document.getElementById('torchBtn');
  const $lastMsg = document.getElementById('lastMsg');
  const $scanBox = document.getElementById('scanBox');
  const $guide = document.getElementById('guide');

  // 입력 대문자 고정
  $input.addEventListener('input', () => {
    const pos = $input.selectionStart;
    $input.value = $input.value.toUpperCase().replace(/\s+/g,'');
    $input.setSelectionRange(pos, pos);
  });

  // ZXing → JsBarcode 포맷 매핑
  function mapFormat(zf, text){
    const BF = ZXing.BarcodeFormat;
    switch (zf) {
      case BF.EAN_13: return "EAN13";
      case BF.EAN_8:  return "EAN8";
      case BF.UPC_A:  return "UPC";
      case BF.CODE_39:return "CODE39";
      case BF.CODE_128:return "CODE128";
      case BF.ITF:    return /^\d{14}$/.test(text) ? "ITF14" : "CODE128"; // ITF14만 지원
      default:        return "CODE128";
    }
  }

  function addBarcode(text, srcFmtLabel="MANUAL", renderFmt="CODE128") {
    if (!text) return;
    text = String(text).toUpperCase();
    // 중복은 최신으로 당김
    state.items = state.items.filter(it => it.text !== text);
    state.items.unshift({ id: crypto.randomUUID(), text, srcFmt: srcFmtLabel, renderFmt });
    if (state.items.length > MAX) state.items.length = MAX;
    render();
  }

  function removeBarcode(id) { state.items = state.items.filter(it => it.id !== id); render(); }

  function render() {
    $col.innerHTML = '';
    state.items.forEach(it => {
      const wrap = document.createElement('div'); wrap.className='slot';
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      const txtWrap = document.createElement('div');
      const txt = document.createElement('div'); txt.className='code'; txt.textContent = it.text;
      const meta = document.createElement('div'); meta.className='meta';
      meta.textContent = (it.srcFmt === 'MANUAL')
        ? `생성 포맷: ${it.renderFmt}`
        : `스캔 포맷: ${it.srcFmt} → 생성 포맷: ${it.renderFmt}`;
      const del = document.createElement('button'); del.className='x'; del.textContent='✕'; del.onclick=()=>removeBarcode(it.id);

      txtWrap.appendChild(txt); txtWrap.appendChild(meta);
      wrap.appendChild(svg); wrap.appendChild(txtWrap); wrap.appendChild(del);
      $col.appendChild(wrap);

      try {
        JsBarcode(svg, it.text, { format: it.renderFmt, width: 2, height: 68, displayValue: false, margin: 8 });
      } catch(e) {
        meta.textContent += ` (렌더 실패: ${e?.message || e})`;
      }
    });
  }

  // 수동 생성
  $gen.onclick = () => { addBarcode($input.value.trim(), "MANUAL", "CODE128"); $input.value=''; $input.focus(); };

  // 전체 지움
  $clear.onclick = () => { state.items=[]; render(); };

  // 토치
  $torch.onclick = async () => {
    try {
      if (!state.track) return alert('카메라가 켜진 뒤 사용 가능합니다.');
      const caps = state.track.getCapabilities?.();
      if (!caps || !('torch' in caps)) return alert('토치를 지원하지 않는 기기입니다.');
      state.torchOn = !state.torchOn;
      await state.track.applyConstraints({ advanced: [{ torch: state.torchOn }] });
      $torch.textContent = state.torchOn ? '🔦 끄기' : '🔦';
    } catch (e) { alert('토치 실패: ' + (e?.message || e)); }
  };

  // 후면 카메라 선택
  async function pickBackCameraDeviceId() {
    let tmp; try { tmp = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment'} } }); tmp.getTracks().forEach(t=>t.stop()); } catch(_){}
    const devs = await navigator.mediaDevices.enumerateDevices(); const vids = devs.filter(d=>d.kind==='videoinput');
    const rear = vids.find(d=>/rear|back|environment|후면/i.test(d.label));
    return (rear?.deviceId) || (vids[1]?.deviceId) || (vids[0]?.deviceId) || null;
  }

  let reader = null;

  // 연속 스캔 시작
  async function startScan() {
    if (!window.isSecureContext) { alert('HTTPS 또는 localhost에서만 동작합니다.'); return; }
    if (state.running) return;

    state.running = true; $camStatus.textContent = '시작중…';

    const deviceId = await pickBackCameraDeviceId();
    if (!deviceId) { alert('카메라 장치를 찾지 못했습니다.'); state.running=false; return; }

    // 프리뷰(고해상도 우선 시도)
    let stream;
    for (const cons of [
      { video:{ deviceId:{ exact:deviceId }, width:{ideal:2560}, height:{ideal:1440} } },
      { video:{ deviceId:{ exact:deviceId }, width:{ideal:1920}, height:{ideal:1080} } },
      { video:{ deviceId:{ exact:deviceId } } }
    ]) { try { stream = await navigator.mediaDevices.getUserMedia(cons); break; } catch{} }
    if (!stream) { alert('카메라 열기 실패'); state.running=false; return; }

    $video.srcObject = stream; await $video.play();
    state.track = stream.getVideoTracks()[0];

    // ZXing 힌트: 리테일 중심 + TRY_HARDER
    const H = ZXing.DecodeHintType, F = ZXing.BarcodeFormat;
    const hints = new Map();
    hints.set(H.POSSIBLE_FORMATS, [F.EAN_13, F.EAN_8, F.UPC_A, F.CODE_128, F.CODE_39, F.ITF]);
    hints.set(H.TRY_HARDER, true);

    reader = new ZXing.BrowserMultiFormatReader(hints, 500);
    await reader.decodeFromVideoDevice(deviceId, $video, (result, err) => {
      const now = Date.now();
      if (now < cooldownUntil) { $camStatus.textContent = '대기중…'; return; }

      if (result) {
        const text = result.getText ? result.getText() : result.text;
        const fmtEnum = result.getBarcodeFormat ? result.getBarcodeFormat() : result.barcodeFormat;
        const fmtLabel = ZXing.BarcodeFormat[fmtEnum] || 'UNKNOWN';
        const renderFmt = mapFormat(fmtEnum, text);

        state.lastDetected = text; state.lastDetectAt = now;
        addBarcode(text, fmtLabel, renderFmt);
        $lastMsg.textContent = `인식: ${text} (${fmtLabel})`;
        $camStatus.textContent = '감지됨';

        cooldownUntil = now + COOLDOWN_MS; // 1초 쿨다운
      } else if (err && !(err instanceof ZXing.NotFoundException)) {
        console.warn(err); $camStatus.textContent = '오류';
      } else {
        $camStatus.textContent = '검색중…';
      }
    });
  }

  // 스캔 정지
  function stopScan() {
    state.running = false;
    try { reader?.reset(); } catch {}
    const s = $video.srcObject; if (s) { s.getTracks().forEach(t=>t.stop()); $video.srcObject=null; }
    state.track=null; state.torchOn=false; cooldownUntil=0; $camStatus.textContent='정지';
  }

  // 버튼 연결
  $scan.onclick = startScan;
  $stop.onclick = stopScan;

  // ─────────── 탭-투-스캔: 고정 가로비 ROI 인식 ───────────
  const roiCanvas = document.createElement('canvas');
  const roiCtx = roiCanvas.getContext('2d', { willReadFrequently:true });

  $scanBox.addEventListener('click', async (e) => {
    if (!$video.videoWidth) return;
    const now = Date.now(); if (now < cooldownUntil) return;

    // 1) 탭 좌표 (0~1)
    const rect = $video.getBoundingClientRect();
    const px = (e.clientX - rect.left) / rect.width;
    const py = (e.clientY - rect.top) / rect.height;

    // 2) 고정 가로비 ROI 계산 (AR=4:1, 너비=화면 80%)
    const AR = 4.0;
    const vw = $video.videoWidth, vh = $video.videoHeight;
    const rw = Math.round(vw * 0.80);
    const rh = Math.round(rw / AR);
    let cx = Math.round(vw * px), cy = Math.round(vh * py);
    let x = Math.max(0, Math.min(vw - rw, cx - Math.round(rw/2)));
    let y = Math.max(0, Math.min(vh - rh, cy - Math.round(rh/2)));

    // 3) 가이드 박스 위치/크기 반영
    const leftPct = ((x + rw/2) / vw) * 100;
    const topPct  = ((y + rh/2) / vh) * 100;
    const wPct    = (rw / vw) * 100;
    const hPct    = (rh / vh) * 100;
    $guide.style.setProperty('--x', leftPct + '%');
    $guide.style.setProperty('--y', topPct + '%');
    $guide.style.setProperty('--w', wPct + '%');
    $guide.style.setProperty('--h', hPct + '%');

    // 4) ROI 캡처
    roiCanvas.width = rw; roiCanvas.height = rh;
    roiCtx.drawImage($video, x, y, rw, rh, 0, 0, rw, rh);

    // 5) 1차: BarcodeDetector (있으면)
    let recognized = false;
    if ('BarcodeDetector' in window) {
      try {
        const det = new window.BarcodeDetector({ formats: ['ean_13','ean_8','upc_a','code_128','code_39','itf'] });
        const bmp = await createImageBitmap(roiCanvas);
        const res = await det.detect(bmp);
        if (res && res.length && res[0].rawValue) {
          onTapDetected(res[0].rawValue, res[0].format);
          recognized = true;
        }
      } catch(_) {}
    }

    // 6) 2차: ZXing로 ROI 이미지 1회 디코드
    if (!recognized) {
      try {
        const H = ZXing.DecodeHintType, F = ZXing.BarcodeFormat;
        const hints = new Map(); hints.set(H.POSSIBLE_FORMATS, [F.EAN_13,F.EAN_8,F.UPC_A,F.CODE_128,F.CODE_39,F.ITF]); hints.set(H.TRY_HARDER,true);
        const one = new ZXing.BrowserMultiFormatReader(hints);
        const img = new Image();
        img.onload = async () => {
          try {
            const result = await one.decodeFromImage(img);
            const t = result.getText ? result.getText() : result.text;
            const fmtEnum = result.getBarcodeFormat ? result.getBarcodeFormat() : result.barcodeFormat;
            onTapDetected(t, ZXing.BarcodeFormat[fmtEnum] || 'UNKNOWN', fmtEnum);
          } catch { $lastMsg.textContent = '탭 영역에서 바코드 미검출'; }
        };
        img.src = roiCanvas.toDataURL('image/png');
      } catch {
        $lastMsg.textContent = '탭 스캔 오류';
      }
    }
  });

  function onTapDetected(text, fmtLabel, fmtEnum){
    const now = Date.now(); if (!text) return;
    const renderFmt = (typeof fmtEnum === 'number') ? mapFormat(fmtEnum, text)
                      : (fmtLabel && fmtLabel.toUpperCase().includes('EAN_13')) ? 'EAN13'
                      : (fmtLabel && fmtLabel.toUpperCase().includes('EAN_8'))  ? 'EAN8'
                      : (fmtLabel && fmtLabel.toUpperCase().includes('UPC_A'))  ? 'UPC'
                      : (fmtLabel && fmtLabel.toUpperCase().includes('CODE_39'))? 'CODE39' : 'CODE128';
    addBarcode(text, fmtLabel || 'TAP', renderFmt);
    $lastMsg.textContent = `탭 인식: ${text} (${fmtLabel||'?'})`;
    $camStatus.textContent = '감지됨';
    cooldownUntil = now + COOLDOWN_MS;
  }

  // 이벤트 마운트
  render();
})();
</script>
</body>
</html>
