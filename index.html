<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>모바일 바코드 제네레이터</title>

<style>
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .topbar{position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #eee; padding:10px; display:flex; flex-direction:column; gap:8px}
  .controls{display:flex; gap:8px}
  .controls input[type=text]{flex:1; height:40px; padding:0 12px; font-size:16px; border:1px solid #ddd; border-radius:10px}
  .btn{height:40px; padding:0 14px; border-radius:10px; border:1px solid #111; background:#111; color:#fff; font-weight:600}
  .btn.outline{background:#fff; color:#111}
  .slot-col{display:flex; flex-direction:column; gap:8px; max-height:70vh; overflow-y:auto; padding-bottom:4px}
  .slot{display:flex; align-items:center; gap:8px; border:1px solid #eee; border-radius:12px; padding:8px}
  .slot svg{width:160px; height:80px}
  .slot .code{font-size:14px; word-break:break-all; color:#333; flex:1}
  .slot .del{width:26px; height:26px; border:none; border-radius:50%; font-size:16px; line-height:26px; background:#f4f4f5; color:#444}
  .wrap{padding:12px}
  video{width:100%; border-radius:12px; background:#000}
  .badge{display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; background:#f4f4f5; margin-left:6px}
</style>

<!-- JsBarcode -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<!-- ZXing UMD -->
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
</head>
<body>

<header class="topbar">
  <div class="controls">
    <input id="textInput" type="text" placeholder="문자/숫자 입력 (자동 대문자)" inputmode="latin" autocomplete="off" />
    <button id="genBtn" class="btn">생성</button>
    <button id="clearBtn" class="btn outline">전체지움</button>
  </div>
  <div class="slot-col" id="slotCol" aria-label="고정된 바코드들 (최대 5개)"></div>
</header>

<main class="wrap">
  <h3>카메라로 제품 바코드 스캔 <span class="badge" id="camStatus">대기</span></h3>
  <div style="display:flex; gap:8px; margin:8px 0;">
    <button id="scanBtn" class="btn" style="flex:1">스캔 시작</button>
    <button id="stopBtn" class="btn outline" style="flex:1">스캔 정지</button>
  </div>
  <video id="preview" playsinline muted></video>
</main>

<script>
(() => {
  if (!window.ZXing) {
    alert('ZXing 라이브러리 로드 실패');
    return;
  }

  const MAX = 5;
  const state = { items: [], lastDetected:"", lastDetectAt:0, running:false, reader:null };

  const $col = document.getElementById('slotCol');
  const $input = document.getElementById('textInput');
  const $gen = document.getElementById('genBtn');
  const $clear = document.getElementById('clearBtn');
  const $scan = document.getElementById('scanBtn');
  const $stop = document.getElementById('stopBtn');
  const $video = document.getElementById('preview');
  const $camStatus = document.getElementById('camStatus');

  // 대문자 고정
  $input.addEventListener('input', () => {
    const pos = $input.selectionStart;
    $input.value = $input.value.toUpperCase().replace(/\s+/g,'');
    $input.setSelectionRange(pos, pos);
  });

  function addBarcode(text) {
    if (!text) return;
    text = String(text).toUpperCase();
    state.items = state.items.filter(it => it.text !== text);
    state.items.unshift({ id: crypto.randomUUID(), text });
    if (state.items.length > MAX) state.items.length = MAX;
    render();
  }

  function removeBarcode(id) {
    state.items = state.items.filter(it => it.id !== id);
    render();
  }

  function clearAll() {
    state.items = [];
    render();
  }

  function render() {
    $col.innerHTML = '';
    state.items.forEach(it => {
      const row = document.createElement('div'); row.className = 'slot';
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      const txt = document.createElement('div'); txt.className = 'code'; txt.textContent = it.text;
      const del = document.createElement('button'); del.className = 'del'; del.textContent = '×';
      del.onclick = () => removeBarcode(it.id);
      row.appendChild(svg); row.appendChild(txt); row.appendChild(del);
      $col.appendChild(row);
      try {
        JsBarcode(svg, it.text, { format:"CODE128", width:2, height:80, displayValue:false, margin:8 });
      } catch {}
    });
  }

  $gen.onclick = () => { addBarcode($input.value.trim()); $input.value=''; $input.focus(); };
  $input.onkeydown = e => { if (e.key==='Enter') { e.preventDefault(); $gen.click(); } };
  $clear.onclick = clearAll;

  async function startScan() {
    // HTTPS / localhost 체크
    if (!window.isSecureContext) {
      alert('카메라는 보안 컨텍스트에서만 동작합니다.\nHTTPS로 접속하거나 안드로이드에서 localhost 서버로 열어주세요.');
      return;
    }

    if (state.running) return;
    try {
      $camStatus.textContent = '시작중…';
      const { BrowserMultiFormatReader, NotFoundException } = ZXing;
      state.reader = new BrowserMultiFormatReader();
      state.running = true;

      await state.reader.decodeFromConstraints(
        { video: { facingMode: "environment" } },
        $video,
        (result, err) => {
          if (result) {
            const now = Date.now();
            const text = result.getText ? result.getText() : result.text;
            if (text === state.lastDetected && (now - state.lastDetectAt) < 1500) return;
            state.lastDetected = text;
            state.lastDetectAt = now;
            addBarcode(text);
            $camStatus.textContent = '감지됨';
          } else if (err && !(err instanceof NotFoundException)) {
            $camStatus.textContent = '오류'; console.warn(err);
          } else {
            $camStatus.textContent = '검색중…';
          }
        }
      );
    } catch (e) {
      $camStatus.textContent = '오류';
      alert('스캔 시작 실패: ' + (e?.message || e));
      stopScan();
    }
  }

  function stopScan() {
    state.running = false;
    try { state.reader?.reset(); } catch {}
    const s = $video.srcObject; 
    if (s) { s.getTracks().forEach(t => t.stop()); $video.srcObject = null; }
    $camStatus.textContent = '정지';
  }

  $scan.onclick = startScan;
  $stop.onclick = stopScan;

  render();
})();
</script>
</body>
</html>
